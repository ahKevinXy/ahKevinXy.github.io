"use strict";(self.webpackChunkah_kevin_xy=self.webpackChunkah_kevin_xy||[]).push([[99812],{63151:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>d,contentTitle:()=>t,default:()=>o,frontMatter:()=>r,metadata:()=>c,toc:()=>h});var l=i(85893),s=i(11151);const r={title:"BBR \u7b97\u6cd5",authors:"ahKevinXy",description:"BBR \u7b97\u6cd5",image:"https://source.unsplash.com/random?people&61"},t="BBR \u7b97\u6cd5",c={permalink:"/blog/2023/11/14/bbr",source:"@site/blog/2023/11/14/bbr.md",title:"BBR \u7b97\u6cd5",description:"BBR \u7b97\u6cd5",date:"2023-11-14T00:00:00.000Z",formattedDate:"2023\u5e7411\u670814\u65e5",tags:[],readingTime:4.71,hasTruncateMarker:!1,authors:[{name:"ahKevinXy",title:"\u4f5c\u8005",url:"https://github.com/ahKevinXy",email:"ahkevinxy@gmail.com",imageURL:"/img/headers.png",key:"ahKevinXy"}],frontMatter:{title:"BBR \u7b97\u6cd5",authors:"ahKevinXy",description:"BBR \u7b97\u6cd5",image:"https://source.unsplash.com/random?people&61"},unlisted:!1,nextItem:{title:"Gin \u6846\u67b6\u6570\u636e\u7ed3\u6784",permalink:"/blog/2023/11/10/gin"}},d={authorsImageUrls:[void 0]},h=[{value:"\u4ec0\u4e48\u662fbbr \u7b97\u6cd5",id:"\u4ec0\u4e48\u662fbbr-\u7b97\u6cd5",level:2},{value:"\u9650\u6d41\u89c4\u5219",id:"\u9650\u6d41\u89c4\u5219",level:2},{value:"\u6307\u6807\u8bf4\u660e",id:"\u6307\u6807\u8bf4\u660e",level:2},{value:"\u6ed1\u52a8\u7a97\u53e3",id:"\u6ed1\u52a8\u7a97\u53e3",level:2},{value:"\u81ea\u9002\u5e94\u9650\u6d41\u7b56\u7565",id:"\u81ea\u9002\u5e94\u9650\u6d41\u7b56\u7565",level:2},{value:"\u9650\u6d41\u516c\u5f0f",id:"\u9650\u6d41\u516c\u5f0f",level:2},{value:"\u9650\u6d41\u9608\u503c",id:"\u9650\u6d41\u9608\u503c",level:2},{value:"\u6e90\u7801\u5206\u6790",id:"\u6e90\u7801\u5206\u6790",level:2}];function x(n){const e={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.a)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.h2,{id:"\u4ec0\u4e48\u662fbbr-\u7b97\u6cd5",children:"\u4ec0\u4e48\u662fbbr \u7b97\u6cd5"}),"\n",(0,l.jsx)(e.p,{children:"\u81ea\u9002\u5e94\u9650\u6d41 \u4ece\u6574\u4f53\u7ef4\u5ea6\u5bf9\u5e94\u5e94\u7528\u5165\u53e3\u6d41\u91cf\u8fdb\u884c\u63a7\u5236,\u7ed3\u5408\u5e94\u7528\u7684Load CPU\u4f7f\u7528\u7387,\u603b\u4f53\u5e73\u5747RT,\u5165\u53e3QPS\u548c\u5e76\u53d1\u7ebf\u7a0b\u7b49\u51e0\u4e2a\u7ef4\u5ea6\u7684\u76d1\u63a7\u6307\u6807,\u901a\u8fc7\u81ea\u9002\u5e94\u7684\u6d41\u63a7\u7b56\u7565,\u8ba9\u7cfb\u7edf\u7684\u5165\u53e3\u6d41\u91cf\u548c\u7cfb\u7edf\u8d1f\u8f7d\u8fbe\u5230\u4e00\u4e2a\u5e73\u8861,\u8ba9\u7cfb\u7edf\u5c3d\u53ef\u80fd\u8dd1\u5230\u6700\u5927\u541e\u5410\u91cf\u7684\u540c\u65f6\u4fdd\u8bc1\u7cfb\u7edf\u6574\u4f53\u7684\u7a33\u5b9a\u6027"}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"\u6838\u5fc3\u76ee\u6807"})}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u81ea\u52a8\u55c5\u63a2\u8d1f\u8f7d\u548cqps,\u51cf\u5c11\u4eba\u5de5\u914d\u7f6e"}),"\n",(0,l.jsx)(e.li,{children:"\u524a\u9876,\u4fdd\u8bc1\u8d85\u8f7d\u65f6\u7cfb\u7edf\u4e0d\u5954\u6e83,\u5e76\u80fd\u4ee5\u9ad8\u6c34\u51c6qps\u8fd0\u884c"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"\u9650\u6d41\u89c4\u5219",children:"\u9650\u6d41\u89c4\u5219"}),"\n",(0,l.jsxs)(e.p,{children:[(0,l.jsx)(e.strong,{children:"\u8ba1\u7b97\u541e\u5410\u91cf"})," : \u5229\u7279\u5c14\u6cd5\u5219: ",(0,l.jsx)(e.code,{children:"L=\u03bb * W"})]}),"\n",(0,l.jsx)(e.h2,{id:"\u6307\u6807\u8bf4\u660e",children:"\u6307\u6807\u8bf4\u660e"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5165\u53e3QPS: \u6307\u7684\u662f\u4ece\u5916\u90e8\u8bbf\u95ee\u7cfb\u7edf\u7684\u8bf7\u6c42\u6570,\u5373\u8bf7\u6c42\u6570/\u79d2"}),"\n",(0,l.jsx)(e.li,{children:"\u5165\u53e3RT: \u6307\u7684\u662f\u4ece\u5916\u90e8\u8bbf\u95ee\u7cfb\u7edf\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4,\u5373\u54cd\u5e94\u65f6\u95f4/\u79d2"}),"\n",(0,l.jsx)(e.li,{children:"\u5165\u53e3CPU\u4f7f\u7528\u7387: \u6307\u7684\u662f\u4ece\u5916\u90e8\u8bbf\u95ee\u7cfb\u7edf\u7684\u5e73\u5747CPU\u4f7f\u7528\u7387,\u5373CPU\u4f7f\u7528\u7387/\u79d2"}),"\n",(0,l.jsx)(e.li,{children:"\u5165\u53e3\u5e76\u53d1\u7ebf\u7a0b\u6570: \u6307\u7684\u662f\u4ece\u5916\u90e8\u8bbf\u95ee\u7cfb\u7edf\u7684\u5e76\u53d1\u7ebf\u7a0b\u6570"}),"\n",(0,l.jsx)(e.li,{children:"\u7cfb\u7edf\u8d1f\u8f7d: \u6307\u7684\u662f\u7cfb\u7edf\u7684\u5e73\u5747CPU\u4f7f\u7528\u7387,\u5373CPU\u4f7f\u7528\u7387/\u79d2"}),"\n",(0,l.jsx)(e.li,{children:"\u7cfb\u7edf\u5e73\u5747RT: \u6307\u7684\u662f\u7cfb\u7edf\u7684\u5e73\u5747\u54cd\u5e94\u65f6\u95f4,\u5373\u54cd\u5e94\u65f6\u95f4/\u79d2"}),"\n",(0,l.jsx)(e.li,{children:"\u7cfb\u7edf\u5e76\u53d1\u7ebf\u7a0b\u6570: \u6307\u7684\u662f\u7cfb\u7edf\u7684\u5e76\u53d1\u7ebf\u7a0b\u6570"}),"\n"]}),"\n",(0,l.jsxs)(e.table,{children:[(0,l.jsx)(e.thead,{children:(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.th,{children:"\u6307\u6807\u540d\u79f0"}),(0,l.jsx)(e.th,{children:"\u6307\u6807\u542b\u4e49"})]})}),(0,l.jsxs)(e.tbody,{children:[(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"cpu"}),(0,l.jsx)(e.td,{children:"\u6700\u8fd11s cpu\u4f7f\u7528\u7387\u5747\u503c,\u4f7f\u7528\u6ed1\u52a8\u5e73\u5747\u8ba1\u7b97,\u91c7\u6837\u5468\u671f250ms"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"inflight"}),(0,l.jsx)(e.td,{children:"\u5f53\u524d\u5904\u7406\u4e2d\u6b63\u5728\u8fdb\u884c\u5904\u7406\u7684\u8bf7\u6c42\u6570\u91cf"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"pass"}),(0,l.jsx)(e.td,{children:"\u8bf7\u6c42\u5904\u7406\u6210\u529f\u6570\u91cf"})]}),(0,l.jsxs)(e.tr,{children:[(0,l.jsx)(e.td,{children:"rt"}),(0,l.jsx)(e.td,{children:"\u8bf7\u6c42\u6210\u529f\u54cd\u5e94\u8017\u65f6"})]})]})]}),"\n",(0,l.jsx)(e.h2,{id:"\u6ed1\u52a8\u7a97\u53e3",children:"\u6ed1\u52a8\u7a97\u53e3"}),"\n",(0,l.jsx)(e.p,{children:"\u5728\u81ea\u9002\u5e94\u9650\u6d41\u4fdd\u62a4,\u91c7\u96c6\u5230\u7684\u6307\u6807\u7684\u65f6\u6548\u6027\u5f3a,\u7cfb\u7edf\u53ea\u9700\u8981\u91c7\u96c6\u6700\u8fd1\u4e00\u6bb5\u65f6\u95f4\u7684\u6307\u6807,\u901a\u8fc7\u6ed1\u52a8\u7a97\u53e3\u7684\u65b9\u5f0f,\u8ba1\u7b97\u51fa\u5f53\u524d\u7cfb\u7edf\u7684\u541e\u5410\u91cf,\u5e76\u6839\u636e\u7cfb\u7edf\u7684\u8d1f\u8f7d\u548cQPS,\u52a8\u6001\u8c03\u6574\u9650\u6d41\u9608\u503c"}),"\n",(0,l.jsx)(e.h2,{id:"\u81ea\u9002\u5e94\u9650\u6d41\u7b56\u7565",children:"\u81ea\u9002\u5e94\u9650\u6d41\u7b56\u7565"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u52a8\u6001\u8c03\u6574\u9650\u6d41\u9608\u503c: \u52a8\u6001\u8c03\u6574\u9650\u6d41\u9608\u503c,\u6839\u636e\u7cfb\u7edf\u7684\u8d1f\u8f7d\u548cQPS,\u52a8\u6001\u8c03\u6574\u9650\u6d41\u9608\u503c"}),"\n",(0,l.jsx)(e.li,{children:"\u52a8\u6001\u8c03\u6574\u9608\u503c: \u52a8\u6001\u8c03\u6574\u9650\u6d41\u9608\u503c,\u6839\u636e\u7cfb\u7edf\u7684"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"\u9650\u6d41\u516c\u5f0f",children:"\u9650\u6d41\u516c\u5f0f"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"L = \u03bb * W\n\ncpu > 800 AND (Now - PrevDrop) < 1s AND (MaxPass * MinRt * windows / 1000) < InFlight\n\n"})}),"\n",(0,l.jsx)(e.p,{children:"MaxPass \u8868\u793a\u6700\u8fd1 5s \u5185\uff0c\u5355\u4e2a\u91c7\u6837\u7a97\u53e3\u4e2d\u6700\u5927\u7684\u8bf7\u6c42\u6570\u3002 MinRt \u8868\u793a\u6700\u8fd1 5s \u5185\uff0c\u5355\u4e2a\u91c7\u6837\u7a97\u53e3\u4e2d\u6700\u5c0f\u7684\u54cd\u5e94\u65f6\u95f4\u3002 windows \u8868\u793a\u4e00\u79d2\u5185\u91c7\u6837\u7a97\u53e3\u7684\u6570\u91cf\uff0c\u9ed8\u8ba4\u914d\u7f6e\u4e2d\u662f 5s 50 \u4e2a\u91c7\u6837\uff0c\u90a3\u4e48 windows \u7684\u503c\u4e3a 10\u3002"}),"\n",(0,l.jsx)(e.h2,{id:"\u9650\u6d41\u9608\u503c",children:"\u9650\u6d41\u9608\u503c"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9759\u6001\u9608\u503c: \u9759\u6001\u9608\u503c,\u5728\u7cfb\u7edf\u542f\u52a8\u65f6,\u8bbe\u7f6e\u4e00\u4e2a\u56fa\u5b9a\u9608\u503c,\u4e0d\u968f\u7cfb\u7edf\u8d1f\u8f7d\u548cQPS\u7684\u53d8\u5316\u800c\u53d8\u5316"}),"\n",(0,l.jsx)(e.li,{children:"\u52a8\u6001\u9608\u503c: \u52a8\u6001\u9608\u503c,\u5728\u7cfb\u7edf\u542f\u52a8\u65f6,\u8bbe\u7f6e\u4e00\u4e2a\u521d\u59cb\u9608\u503c,\u968f\u7740\u7cfb\u7edf\u8d1f\u8f7d\u548cQPS\u7684\u53d8\u5316\u800c\u53d8\u5316"}),"\n"]}),"\n",(0,l.jsx)(e.h2,{id:"\u6e90\u7801\u5206\u6790",children:"\u6e90\u7801\u5206\u6790"}),"\n",(0,l.jsx)(e.p,{children:(0,l.jsx)(e.strong,{children:"BBR struct"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-go",children:"package main\n    type BBR struct {\n      cpu cpuGetter \n\t  passStat window.RollingCounter \n\t  rtStat window.RollingCounter\n\t  inFlight int64 \n\t  bucketPerSecond int64\n\t  bucketSize      time.Duration\n\n\n\t\tprevDropTime atomic.Value\n\t\tmaxPASSCache atomic.Value\n\t\tminRtCache   atomic.Value\n\n\t\topts *options\n\t  \n    }\n"})}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"cpu"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"cpu \u6307\u6807\u51fd\u6570,cpu\u7684\u4f7f\u7528\u7387"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"passStat"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u8bf7\u6c42\u6570\u7684\u91c7\u6837\u6570\u636e\uff0c\u4f7f\u7528\u6ed1\u52a8\u7a97\u53e3\u8fdb\u884c\u7edf\u8ba1"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"rtStat"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u54cd\u5e94\u65f6\u95f4\u7684\u91c7\u6837\u6570\u636e\uff0c\u540c\u6837\u4f7f\u7528\u6ed1\u52a8\u7a97\u53e3\u8fdb\u884c\u7edf\u8ba1"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"inFlight"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"inFlight \u5f53\u524d\u7cfb\u7edf\u4e2d\u7684\u8bf7\u6c42\u6570\uff0c\u6570\u636e\u5f97\u6765\u65b9\u6cd5\u662f\uff1a\u4e2d\u95f4\u4ef6\u539f\u7406\u5728\u5904\u7406\u524d+1\uff0c\u5904\u7406handle\u4e4b\u540e\u4e0d\u7ba1\u6210\u529f\u5931\u8d25\u90fd\u51cf\u53bb1"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"bucketPerSecond"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e00\u4e2a bucket \u7684\u65f6\u95f4"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"prevDropTime"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u4e0a\u6b21\u89e6\u53d1\u9650\u6d41\u65f6\u95f4"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"bucketSize"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u6876\u7684\u6570\u91cf"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"maxPASSCache"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5355\u4e2a\u91c7\u6837\u7a97\u53e3\u4e2d\u6700\u5927\u7684\u8bf7\u6c42\u6570\u7684\u7f13\u5b58\u6570\u636e"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"minRtCache"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u5355\u4e2a\u91c7\u6837\u7a97\u53e3\u4e2d\u6700\u5c0f\u7684\u54cd\u5e94\u65f6\u95f4\u7684\u7f13\u5b58\u6570\u636e"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(e.li,{children:[(0,l.jsx)(e.code,{children:"opts"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:"\u9650\u6d41\u53c2\u6570"}),"\n"]}),"\n"]}),"\n"]})]})}function o(n={}){const{wrapper:e}={...(0,s.a)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(x,{...n})}):x(n)}},11151:(n,e,i)=>{i.d(e,{Z:()=>c,a:()=>t});var l=i(67294);const s={},r=l.createContext(s);function t(n){const e=l.useContext(r);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:t(n.components),l.createElement(r.Provider,{value:e},n.children)}}}]);