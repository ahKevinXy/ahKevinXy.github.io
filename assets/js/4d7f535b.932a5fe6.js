"use strict";(self.webpackChunkah_kevin_xy=self.webpackChunkah_kevin_xy||[]).push([[27688],{8873:(n,e,c)=>{c.r(e),c.d(e,{assets:()=>o,contentTitle:()=>r,default:()=>x,frontMatter:()=>i,metadata:()=>a,toc:()=>d});var t=c(85893),l=c(11151);const i={},r="\u57fa\u7840\u77e5\u8bc6",a={id:"backend/go/base/base_base",title:"\u57fa\u7840\u77e5\u8bc6",description:"go init()",source:"@site/docs/backend/go/base/base_base.md",sourceDirName:"backend/go/base",slug:"/backend/go/base/base_base",permalink:"/docs/backend/go/base/base_base",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u6570\u7ec4\u3001\u5b57\u7b26\u4e32\u548c\u5207\u7247",permalink:"/docs/backend/go/base/array_string_slice"},next:{title:"Channel \u5b66\u4e60",permalink:"/docs/backend/go/base/channel"}},o={},d=[{value:"go init()",id:"go-init",level:2},{value:"\u6307\u9488",id:"\u6307\u9488",level:2},{value:"\u5e38\u91cf",id:"\u5e38\u91cf",level:2},{value:"\u5173\u952e\u5b57",id:"\u5173\u952e\u5b57",level:2},{value:"New\u548cMake",id:"new\u548cmake",level:2},{value:"Goroutine Channel \u7684\u4f7f\u7528\u73af\u5883",id:"goroutine-channel-\u7684\u4f7f\u7528\u73af\u5883",level:2},{value:"\u4ec0\u4e48\u573a\u666f\u4f7f\u7528 channel \u5408\u9002",id:"\u4ec0\u4e48\u573a\u666f\u4f7f\u7528-channel-\u5408\u9002",level:3},{value:"\u64cd\u4f5c\u7cfb\u7edf\u4e2d \u7ebf\u7a0b\u548c goroutine \u7684\u5173\u7cfb",id:"\u64cd\u4f5c\u7cfb\u7edf\u4e2d-\u7ebf\u7a0b\u548c-goroutine-\u7684\u5173\u7cfb",level:3},{value:"\u901a\u9053 channel \u4f7f\u7528\u5b9e\u4f8b",id:"\u901a\u9053-channel-\u4f7f\u7528\u5b9e\u4f8b",level:3},{value:"channel \u5347\u7ea7\uff0c\u5355\u901a\u9053\uff0c\u53ea\u8bfb\u901a\u9053\u548c\u53ea\u5199\u901a\u9053",id:"channel-\u5347\u7ea7\u5355\u901a\u9053\u53ea\u8bfb\u901a\u9053\u548c\u53ea\u5199\u901a\u9053",level:3},{value:"GMP \u6a21\u578b",id:"gmp-\u6a21\u578b",level:2},{value:"\u8fdb\u7a0b",id:"\u8fdb\u7a0b",level:3},{value:"\u7ebf\u7a0b",id:"\u7ebf\u7a0b",level:3},{value:"\u534f\u7a0b",id:"\u534f\u7a0b",level:3},{value:"\u5b9a\u4e49",id:"\u5b9a\u4e49",level:3},{value:"\u6a21\u578b",id:"\u6a21\u578b",level:3},{value:"\u72b6\u6001\u6c47\u603b",id:"\u72b6\u6001\u6c47\u603b",level:3},{value:"G \u72b6\u6001",id:"g-\u72b6\u6001",level:4},{value:"P \u7684\u72b6\u6001",id:"p-\u7684\u72b6\u6001",level:4},{value:"M \u7684\u72b6\u6001",id:"m-\u7684\u72b6\u6001",level:4},{value:"\u8c03\u5ea6\u573a\u666f",id:"\u8c03\u5ea6\u573a\u666f",level:4},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:4},{value:"GO \u6253\u5305",id:"go-\u6253\u5305",level:2},{value:"\u6253\u5305 linux",id:"\u6253\u5305-linux",level:3},{value:"\u6253\u5305 windows",id:"\u6253\u5305-windows",level:3},{value:"\u6253\u5305 mac",id:"\u6253\u5305-mac",level:3},{value:"Go \u4e4b context",id:"go-\u4e4b-context",level:2},{value:"\u4e3a\u4ec0\u4e48\u9700\u8981 context",id:"\u4e3a\u4ec0\u4e48\u9700\u8981-context",level:3},{value:"context \u63a5\u53e3",id:"context-\u63a5\u53e3",level:3},{value:"emptyCtx",id:"emptyctx",level:3},{value:"valueCtx",id:"valuectx",level:3},{value:"WithValue",id:"withvalue",level:3},{value:"cancelCtx",id:"cancelctx",level:3},{value:"WithCancel",id:"withcancel",level:3},{value:"timerCtx",id:"timerctx",level:3},{value:"WithDeadline",id:"withdeadline",level:3},{value:"WithTimeout",id:"withtimeout",level:3},{value:"context \u7684\u4f7f\u7528",id:"context-\u7684\u4f7f\u7528",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3-1",level:3}];function s(n){const e={admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.a)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.h1,{id:"\u57fa\u7840\u77e5\u8bc6",children:"\u57fa\u7840\u77e5\u8bc6"}),"\n",(0,t.jsx)(e.h2,{id:"go-init",children:"go init()"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.code,{children:"init()"}),"\u51fd\u6570\u4f1a\u5728\u5305\u88ab\u521d\u59cb\u5316\u540e\u81ea\u52a8\u6267\u884c\uff0c\u5e76\u4e14\u5728",(0,t.jsx)(e.code,{children:"main()"}),"\u51fd\u6570\u4e4b\u524d\u6267\u884c\uff0c\u4f46\u662f\u9700\u8981\u6ce8\u610f\u7684\u662f",(0,t.jsx)(e.code,{children:"init()"}),"\u4ee5\u53ca",(0,t.jsx)(e.code,{children:"main()"}),"\u51fd\u6570\u90fd\u662f\u65e0\u6cd5\u88ab\u663e\u5f0f\u8c03\u7528\u7684\u3002"]}),"\n",(0,t.jsxs)(e.p,{children:["\u90a3\u4e48",(0,t.jsx)(e.code,{children:"init()"}),"\u662f\u4e0d\u662f\u6700\u5148\u6267\u884c\u7684\u5462\uff1f \u7b54\u6848\u662f\u5426\u5b9a\u7684\uff0c\u9996\u5148\uff0c\u5728\u4ed6\u4e4b\u524d\u4f1a\u8fdb\u884c\u5168\u5c40\u53d8\u91cf\u7684\u521d\u59cb\u5316\uff1b"]}),"\n",(0,t.jsx)(e.admonition,{type:"info",children:(0,t.jsxs)(e.p,{children:["\u5f53\u6211\u4eec\u5bfc\u5165\u5176\u4ed6\u5305\u65f6\uff0c\u4f1a\u5148\u521d\u59cb\u5316\u5bfc\u5165\u7684\u5305\uff0c\u800c\u521d\u59cb\u5316\u5305\u65f6\uff0c\u4f1a\u5148\u52a0\u8f7d\u5168\u5c40\u53d8\u91cf\uff0c\u800c\u540e\u4ece\u4e0a\u5230\u4e0b\u52a0\u8f7d",(0,t.jsx)(e.code,{children:"init()"}),"\u51fd\u6570\uff0c\u5f53\u88ab\u5bfc\u5165\u7684\u5305\u7684",(0,t.jsx)(e.code,{children:"init()"}),"\u51fd\u6570\u6267\u884c\u5b8c\u6bd5\u540e\uff0c\u6267\u884c\u8c03\u7528\u65b9\u7684\u5168\u5c40\u53d8\u91cf\u52a0\u8f7d\uff0c",(0,t.jsx)(e.code,{children:"init()"}),"\u51fd\u6570\u7684\u987a\u5e8f\u52a0\u8f7d\uff0c\u4e4b\u540e\u6267\u884c",(0,t.jsx)(e.code,{children:"main()"}),"\u51fd\u6570\u3002"]})}),"\n",(0,t.jsx)(e.h2,{id:"\u6307\u9488",children:"\u6307\u9488"}),"\n",(0,t.jsx)(e.p,{children:"Go \u8bed\u8a00\u4e3a\u7a0b\u5e8f\u5458\u63d0\u4f9b\u4e86\u63a7\u5236\u6570\u636e\u7ed3\u6784\u7684\u6307\u9488\u7684\u80fd\u529b\uff1b\u4f46\u662f\uff0c\u4f60\u4e0d\u80fd\u8fdb\u884c\u6307\u9488\u8fd0\u7b97\u3002\u901a\u8fc7\u7ed9\u4e88\u7a0b\u5e8f\u5458\u57fa\u672c\u5185\u5b58\u5e03\u5c40\uff0cGo \u8bed\u8a00\u5141\u8bb8\u4f60\u63a7\u5236\u7279\u5b9a\u96c6\u5408\u7684\u6570\u636e\u7ed3\u6784\u3001\u5206\u914d\u7684\u6570\u91cf\u4ee5\u53ca\u5185\u5b58\u8bbf\u95ee\u6a21\u5f0f\uff0c\u8fd9\u4e9b\u5bf9\u6784\u5efa\u8fd0\u884c\u826f\u597d\u7684\u7cfb\u7edf\u662f\u975e\u5e38\u91cd\u8981\u7684\uff1a\u6307\u9488\u5bf9\u4e8e\u6027\u80fd\u7684\u5f71\u54cd\u662f\u4e0d\u8a00\u800c\u55bb\u7684\uff0c\u800c\u5982\u679c\u4f60\u60f3\u8981\u505a\u7684\u662f\u7cfb\u7edf\u7f16\u7a0b\u3001\u64cd\u4f5c\u7cfb\u7edf\u6216\u8005\u7f51\u7edc\u5e94\u7528\uff0c\u6307\u9488\u66f4\u662f\u4e0d\u53ef\u6216\u7f3a\u7684\u4e00\u90e8\u5206\u3002"}),"\n",(0,t.jsxs)(e.p,{children:["\u4e00\u4e2a\u6307\u9488\u53d8\u91cf\u53ef\u4ee5\u6307\u5411\u4efb\u4f55\u4e00\u4e2a\u503c\u7684\u5185\u5b58\u5730\u5740 \u5b83\u6307\u5411\u90a3\u4e2a\u503c\u7684\u5185\u5b58\u5730\u5740\uff0c\u5728 ",(0,t.jsx)(e.code,{children:"32"})," \u4f4d\u673a\u5668\u4e0a\u5360\u7528 ",(0,t.jsx)(e.code,{children:"4"}),"\u4e2a\u5b57\u8282\uff0c\u5728 ",(0,t.jsx)(e.code,{children:"64"})," \u4f4d\u673a\u5668\u4e0a\u5360\u7528 ",(0,t.jsx)(e.code,{children:"8"})," \u4e2a\u5b57\u8282\uff0c\u5e76\u4e14\u4e0e\u5b83\u6240\u6307\u5411\u7684\u503c\u7684\u5927\u5c0f\u65e0\u5173\u3002\u5f53\u7136\uff0c\u53ef\u4ee5\u58f0\u660e\u6307\u9488\u6307\u5411\u4efb\u4f55\u7c7b\u578b\u7684\u503c\u6765\u8868\u660e\u5b83\u7684\u539f\u59cb\u6027\u6216\u7ed3\u6784\u6027\uff1b\u4f60\u53ef\u4ee5\u5728\u6307\u9488\u7c7b\u578b\u524d\u9762\u52a0\u4e0a \u53f7\uff08\u524d\u7f00\uff09\u6765\u83b7\u53d6\u6307\u9488\u6240\u6307\u5411\u7684\u5185\u5bb9\uff0c\u8fd9\u91cc\u7684 \u53f7\u662f\u4e00\u4e2a\u7c7b\u578b\u66f4\u6539\u5668\u3002\u4f7f\u7528\u4e00\u4e2a\u6307\u9488\u5f15\u7528\u4e00\u4e2a\u503c\u88ab\u79f0\u4e3a\u95f4\u63a5\u5f15\u7528\u3002"]}),"\n",(0,t.jsx)(e.p,{children:"\u5728\u51fd\u6570\u8c03\u7528\u65f6\uff0c\u50cf\u5207\u7247\uff08slice\uff09\u3001\u5b57\u5178\uff08map\uff09\u3001\u63a5\u53e3\uff08interface\uff09\u3001\u901a\u9053\uff08channel\uff09\u8fd9\u6837\u7684\u5f15\u7528\u7c7b\u578b\u90fd\u662f\u9ed8\u8ba4\u4f7f\u7528\u5f15\u7528\u4f20\u9012\uff08\u5373\u4f7f\u6ca1\u6709\u663e\u5f0f\u7684\u6307\u51fa\u6307\u9488\uff09\u3002"}),"\n",(0,t.jsx)(e.h2,{id:"\u5e38\u91cf",children:"\u5e38\u91cf"}),"\n",(0,t.jsx)(e.p,{children:"\u5e38\u91cf\u4f7f\u7528\u5173\u952e\u5b57 const \u5b9a\u4e49\uff0c\u7528\u4e8e\u5b58\u50a8\u4e0d\u4f1a\u6539\u53d8\u7684\u6570\u636e\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u5728 Go \u8bed\u8a00\u4e2d\uff0c\u4f60\u53ef\u4ee5\u7701\u7565\u7c7b\u578b\u8bf4\u660e\u7b26 [type]\uff0c\u56e0\u4e3a\u7f16\u8bd1\u5668\u53ef\u4ee5\u6839\u636e\u53d8\u91cf\u7684\u503c\u6765\u63a8\u65ad\u5176\u7c7b\u578b\u3002"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u663e\u5f0f\u7c7b\u578b\u5b9a\u4e49\uff1a ",(0,t.jsx)(e.code,{children:'const b string = "abc"'})]}),"\n",(0,t.jsxs)(e.li,{children:["\u9690\u5f0f\u7c7b\u578b\u5b9a\u4e49\uff1a ",(0,t.jsx)(e.code,{children:'const b = "abc"'})]}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u5e38\u91cf\u7684\u503c\u5fc5\u987b\u662f\u80fd\u591f\u5728\u7f16\u8bd1\u65f6\u5c31\u80fd\u591f\u786e\u5b9a\u7684\uff1b\u4f60\u53ef\u4ee5\u5728\u5176\u8d4b\u503c\u8868\u8fbe\u5f0f\u4e2d\u6d89\u53ca\u8ba1\u7b97\u8fc7\u7a0b\uff0c\u4f46\u662f\u6240\u6709\u7528\u4e8e\u8ba1\u7b97\u7684\u503c\u5fc5\u987b\u5728\u7f16\u8bd1\u671f\u95f4\u5c31\u80fd\u83b7\u5f97\u3002"}),"\n",(0,t.jsxs)(e.p,{children:[(0,t.jsx)(e.strong,{children:"\u56e0\u4e3a\u5728\u7f16\u8bd1\u671f\u95f4\u81ea\u5b9a\u4e49\u51fd\u6570\u5747\u5c5e\u4e8e\u672a\u77e5\uff0c\u56e0\u6b64\u65e0\u6cd5\u7528\u4e8e\u5e38\u91cf\u7684\u8d4b\u503c\uff0c\u4f46\u5185\u7f6e\u51fd\u6570\u53ef\u4ee5\u4f7f\u7528\uff0c\u5982\uff1alen()"}),"\n\u5e38\u91cf\u8fd8\u53ef\u4ee5\u7528\u4f5c\u679a\u4e3e\uff1a"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"const (\n    Unknown = 0\n    Female = 1\n    Male = 2\n)\n"})}),"\n",(0,t.jsx)(e.h2,{id:"\u5173\u952e\u5b57",children:"\u5173\u952e\u5b57"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-txt",children:"break default func interface select\ncase defer go map struct\nchan else goto package switch\nconst fallthrough if range type\ncontinue for import return var\n"})}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-txt",children:"\nappend bool byte cap close complex complex64 complex128 uint16\ncopy false float32 float64 imag int int8 int16 uint32\nint32 int64 iota len make new nil panic uint64\nprint println real recover string true uint uint8 uintptr\n"})}),"\n",(0,t.jsx)(e.h2,{id:"new\u548cmake",children:"New\u548cMake"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"new"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"new \u662fgo \u8bed\u8a00\u5185\u7f6e\u7684\u51fd\u6570,\u4ed6\u7684\u51fd\u6570\u7b7e\u540d\u5982\u4e0b"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"fun new(Type) *Type\n"})}),"\n",(0,t.jsx)(e.h2,{id:"goroutine-channel-\u7684\u4f7f\u7528\u73af\u5883",children:"Goroutine Channel \u7684\u4f7f\u7528\u73af\u5883"}),"\n",(0,t.jsx)(e.h3,{id:"\u4ec0\u4e48\u573a\u666f\u4f7f\u7528-channel-\u5408\u9002",children:"\u4ec0\u4e48\u573a\u666f\u4f7f\u7528 channel \u5408\u9002"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"\u901a\u8fc7\u5168\u5c40\u53d8\u91cf\u52a0\u9501\u540c\u6b65\u6765\u5b9e\u73b0\u901a\u8baf,\u5e76\u4e0d\u5229\u4e8e\u591a\u4e2a\u534f\u7a0b\u5bf9\u5168\u5c40\u53d8\u91cf\u7684\u8bfb\u5199\u64cd\u4f5c"}),"\n",(0,t.jsx)(e.li,{children:"\u52a0\u9501\u867d\u7136\u53ef\u4ee5\u89e3\u51b3 goroutine \u5bf9\u5168\u5c40\u53d8\u91cf\u7684\u62a2\u5360\u8d44\u6e90\u95ee\u9898,\u4f46\u662f\u5f71\u54cd\u6027\u80fd"}),"\n",(0,t.jsx)(e.li,{children:"channel \u8fdb\u884c\u534f\u7a0b goroutine \u95f4\u7684\u901a\u4fe1"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u64cd\u4f5c\u7cfb\u7edf\u4e2d-\u7ebf\u7a0b\u548c-goroutine-\u7684\u5173\u7cfb",children:"\u64cd\u4f5c\u7cfb\u7edf\u4e2d \u7ebf\u7a0b\u548c goroutine \u7684\u5173\u7cfb"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"\u64cd\u4f5c\u7cfb\u7edf\u7ebf\u7a0b\u5bf9\u5e94\u7528\u6237\u6001\u591a\u4e2a goroutine"}),"\n",(0,t.jsx)(e.li,{children:"go \u7a0b\u5e8f\u53ef\u4ee5\u540c\u65f6\u4f7f\u7528\u591a\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u7ebf\u7a0b"}),"\n",(0,t.jsxs)(e.li,{children:["goroutine \u548c OS \u7ebf\u7a0b\u662f\u591a\u5bf9\u591a\u7684\u5173\u7cfb m",":n"]}),"\n"]}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"go \u8bed\u8a00\u7684\u5e76\u53d1\u6a21\u578b\u662f CSP (Communicating Sequential Process),\u63d0\u5021\u901a\u8fc7\u901a\u4fe1\u5171\u4eab\u5185\u5b58 \u800c\u4e0d\u662f\u901a\u8fc7\u5171\u4eab\u5185\u5b58\u800c\u5b9e\u73b0\u901a\u4fe1,\u5f15\u51fa\u4e86 channel"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u901a\u9053-channel-\u4f7f\u7528\u5b9e\u4f8b",children:"\u901a\u9053 channel \u4f7f\u7528\u5b9e\u4f8b"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"for range \u4ece\u901a\u9053\u4e2d\u53d6\u503c,\u901a\u9053\u5173\u95ed\u65f6 for range \u9000\u51fa"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"// channel\u7ec3\u4e60 go  for range\u4ecechan\u4e2d\u53d6\u503c\n   ch1 := make(chan int)\n   ch2 := make(chan int)\n\n   // \u5f00\u542fgoroutine \u628a0-100\u5199\u5165\u5230ch1\u901a\u9053\u4e2d\n   go func() {\n      for i := 0; i < 100; i++ {\n         ch1 <- i\n      }\n      close(ch1)\n   }()\n\n// \u5f00\u542fgoroutine \u4ecech1\u4e2d\u53d6\u503c\uff0c\u503c\u7684\u5e73\u65b9\u8d4b\u503c\u7ed9 ch2\n   go func() {\n      for {\n         i,ok := <-ch1 //\u901a\u9053\u53d6\u503c\u540e \u518d\u53d6\u503c ok = false\n         if ok {\n            ch2 <- i*i\n         }else {\n            break\n         }\n      }\n      close(ch2)\n   }()\n\n// \u4e3bgoroutine \u4ecech2\u4e2d\u53d6\u503c \u6253\u5370\u8f93\u51fa\n// for x := chan \u6709\u503c\u53d6\u503c\uff0c\u901a\u9053\u5173\u95ed\u65f6\u8df3\u51fagoroutine\n   for i :=range ch2{\n      fmt.Println(i)\n   }\n"})}),"\n",(0,t.jsx)(e.h3,{id:"channel-\u5347\u7ea7\u5355\u901a\u9053\u53ea\u8bfb\u901a\u9053\u548c\u53ea\u5199\u901a\u9053",children:"channel \u5347\u7ea7\uff0c\u5355\u901a\u9053\uff0c\u53ea\u8bfb\u901a\u9053\u548c\u53ea\u5199\u901a\u9053"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"func counter(in chan<- int) {\n   defer close(in)\n   for i := 0; i < 100; i++ {\n      in <- i\n   }\n}\n\nfunc square(in chan<- int, out <-chan int) {\n   defer close(in)\n   for i := range out {\n      in <- i * i\n   }\n}\n\nfunc output(out <-chan int)  {\n   for i:=range out{\n      fmt.Println(i)\n   }\n}\n\n// \u6539\u5199\u6210\u5355\u5411\u901a\u9053\nfunc main() {\n   ch1 := make(chan int)\n   ch2 := make(chan int)\n   go counter(ch1)\n   go square(ch2, ch1)\n   output(ch2)\n}\n"})}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"goroutine work pool\uff0c\u53ef\u4ee5\u9632\u6b62 goroutine \u66b4\u6da8\u6216\u8005\u6cc4\u9732"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:'//\u4f7f\u7528work pool \u9632\u6b62goroutine\u7684\u6cc4\u9732\u548c\u66b4\u6da8\nfunc worker(id int, jobs <-chan int, results chan<- int) {\n   for j := range jobs {\n      fmt.Printf("worker:%d start job:%d\\n", id, j)\n      time.Sleep(time.Second)\n      fmt.Printf("worker:%d end job:%d\\n", id, j)\n      results <- j * 2\n   }\n}\n\nfunc main() {\n   jobs := make(chan int, 100)\n   results := make(chan int, 100)\n   // \u5f00\u542f3\u4e2agoroutine\n   for w := 1; w <= 3; w++ {\n      go worker(w, jobs, results)\n   }\n   // 5\u4e2a\u4efb\u52a1\n   for j := 1; j <= 5; j++ {\n      jobs <- j\n   }\n   close(jobs)\n   // \u8f93\u51fa\u7ed3\u679c\n   for a := 1; a <= 5; a++ {\n      <-results\n   }\n}\n'})}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"goroutine \u4f7f\u7528 select case \u591a\u8def\u590d\u7528\uff0c\u6ee1\u8db3\u6211\u4eec\u540c\u65f6\u4ece\u591a\u4e2a\u901a\u9053\u63a5\u6536\u503c\u7684\u9700\u6c42"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"//\u4f7f\u7528select\u8bed\u53e5\u80fd\u63d0\u9ad8\u4ee3\u7801\u7684\u53ef\u8bfb\u6027\u3002\n//\u53ef\u5904\u7406\u4e00\u4e2a\u6216\u591a\u4e2achannel\u7684\u53d1\u9001/\u63a5\u6536\u64cd\u4f5c\u3002\n//\u5982\u679c\u591a\u4e2acase\u540c\u65f6\u6ee1\u8db3\uff0cselect\u4f1a\u968f\u673a\u9009\u62e9\u4e00\u4e2a\u3002\n//\u5bf9\u4e8e\u6ca1\u6709case\u7684select{}\u4f1a\u4e00\u76f4\u7b49\u5f85\uff0c\u53ef\u7528\u4e8e\u963b\u585emain\u51fd\u6570\u3002\nch := make(chan int, 1)\ngo func() {\n   for i := 0; i < 10; i++ {\n      select {\n      case x := <-ch:\n         fmt.Println(x)\n      case ch <- i:\n      }\n   }\n}()\n"})}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"goroutine \u52a0\u9501 \u6392\u5b83\u9501 \u8bfb\u5199\u9501"}),"\n"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"var x int64\nvar wg sync.WaitGroup\n//\u6dfb\u52a0\u4e92\u65a5\u9501\nvar lock sync.Mutex\n\nfunc main() {\n   wg.Add(2)\n   go add()\n   go add()\n   wg.Wait()\n   fmt.Println(x)\n}\n\nfunc add() {\n   for i := 0; i < 5000; i++ {\n      lock.Lock() //\u52a0\u9501\n      x = x + 1\n      lock.Unlock() //\u89e3\u9501\n   }\n   wg.Done()\n}\n"})}),"\n",(0,t.jsx)(e.h2,{id:"gmp-\u6a21\u578b",children:"GMP \u6a21\u578b"}),"\n",(0,t.jsx)(e.h3,{id:"\u8fdb\u7a0b",children:"\u8fdb\u7a0b"}),"\n",(0,t.jsx)(e.p,{children:"\u5728\u7a0b\u5e8f\u542f\u52a8\u65f6,\u64cd\u4f5c\u7cfb\u7edf\u4f1a\u7ed9\u8be5\u7a0b\u5e8f\u5206\u914d\u4e00\u5757\u5185\u5b58\u7a7a\u95f4,\u5bf9\u4e8e\u7a0b\u5e8f\u4f46\u770b\u5230\u7684\u662f\u4e00\u6574\u5757\u8fde\u7eed\u7684\u50a8\u5b58\u7a7a\u95f4,\u7b80\u79f0\u865a\u62df\u50a8\u5b58\u7a7a\u95f4,\u843d\u5b9e\u5230\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5219\u662f\u4e00\u5757\u4e00\u5757\u7684\u5185\u5b58\u788e\u7247\u7684\u4e1c\u897f,\u4e3a\u4e86\u662f\u8282\u7701\u5185\u6838\u7a7a\u95f4,\u65b9\u4fbf\u5bf9\u5185\u5b58\u7ba1\u7406,\u5bf9\u4e8e\u8fd9\u8fb9\u5185\u5b58\u7a7a\u95f4,\u53c8\u5212\u5206\u4e3a\u7528\u6237\u7a7a\u95f4\u4e0e\u5185\u6838\u7a7a\u95f4,\u7528\u6237\u7a7a\u95f4\u53ea\u7528\u4e8e\u7528\u6237\u7a0b\u5e8f\u7684\u6267\u884c,\u82e5\u8981\u6267\u884c\u5404\u79cd io \u64cd\u4f5c,\u5c31\u4f1a\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u7b49\u8fdb\u5165\u5185\u6838\u7a7a\u95f4\u8fdb\u884c\u64cd\u4f5c .\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u81ea\u5df1\u7684 pid,\u53ef\u4ee5\u901a\u8fc7 ps \u547d\u4ee4\u67e5\u67d0\u4e2a\u8fdb\u7a0b\u7684 pid,\u8fdb\u5165/proc/ \u53ef\u4ee5\u67e5\u770b\u8be5\u8fdb\u7a0b\u7684\u8be6\u7ec6\u4fe1\u606f"}),"\n",(0,t.jsx)(e.h3,{id:"\u7ebf\u7a0b",children:"\u7ebf\u7a0b"}),"\n",(0,t.jsx)(e.p,{children:"\u7ebf\u7a0b\u662f\u8fdb\u7a0b\u7684\u6267\u884c\u5355\u5143,\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u4ee5\u5305\u542b\u591a\u4e2a\u7ebf\u7a0b,\u53ea\u6709\u62e5\u6709\u4e86\u7ebf\u7a0b\u7684\u8fdb\u7a0b\u624d\u4f1a\u88ab cpu \u6267\u884c,\u6240\u4ee5\u4e00\u4e2a\u8fdb\u7a0b\u81f3\u5c11\u6709\u4e00\u4e2a\u4e3b\u8fdb\u7a0b\u7531\u4e8e\u591a\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u5171\u4eab\u4e00\u4e2a\u8fdb\u7a0b\u7684\u5185\u5b58\u7a7a\u95f4,\u5207\u6362\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7684\u5f00\u9500\u5de8\u5927,\u4e3a\u4ec0\u4e48\u8fdb\u7a0b\u5207\u6362\u9700\u8981\u5f00\u9500\u5de8\u5927:\u7b80\u5355\u7406\u89e3 \u5c31\u662f\u56e0\u4e3a\u8fdb\u7a0b\u5207\u6362\u8981\u4fdd\u5b58\u7684\u7ebf\u7a0b\u592a\u591a\u5982\u5bc4\u5b58\u5668,\u6808,\u4ee3\u7801\u6bb5\u6267\u884c\u4f4d\u7f6e,\u800c\u7ebf\u7a0b\u5207\u6362\u53ea\u9700\u8981\u4e0a\u4e0b\u6587\u5207\u6362,\u4fdd\u5b58\u7ebf\u7a0b\u6267\u884c\u7684\u4e0a\u4e0b\u6587\u5c31\u884c.\u7ebf\u7a0b\u7684\u5207\u6362\u53ea\u9700\u8981\u4fdd\u5b58\u7ebf\u7a0b\u7684\u6267\u884c\u73b0\u573a,\u4fdd\u5b58\u5728\u8be5\u7ebf\u7a0b\u7684\u6808\u91cc,CPU \u628a\u6808\u6307\u9488,\u6307\u4ee4\u5bc4\u5b58\u5668\u7684\u503c\u6307\u5411\u4e0b\u4e00\u4e2a\u7ebf\u7a0b ,\u76f8\u6bd4\u7ebf\u7a0b\u66f4\u52a0\u8f7b\u91cf\u7ea7\u53ef\u4ee5\u7406\u89e3\u4e3a \u8fdb\u7a0b\u9762\u5411\u5185\u5b58\u5206\u914d\u7ba1\u7406,\u7ebf\u7a0b\u4e3b\u8981\u9762\u5411 CPU \u8c03\u5ea6"}),"\n",(0,t.jsx)(e.h3,{id:"\u534f\u7a0b",children:"\u534f\u7a0b"}),"\n",(0,t.jsx)(e.p,{children:"\u867d\u7136\u7ebf\u7a0b\u6bd4\u8fdb\u7a0b\u66f4\u8f7b\u91cf\u7ea7,\u4f46\u662f\u6bcf\u4e2a\u7ebf\u7a0b\u4f9d\u7136\u5360\u6709 1M \u5de6\u53f3\u7684\u7a7a\u95f4,\u5728\u9ad8\u5e76\u53d1\u573a\u666f\u4e0b \u975e\u5e38\u5403\u673a\u5668\u5185\u5b58,\u6bd4\u5982\u6784\u5efa\u4e00\u4e2a http \u670d\u52a1\u5668,\u5982\u679c\u6bcf\u4e00\u6b21\u8bf7\u6c42\u5206\u914d\u4e00\u4e2a\u7ebf\u7a0b,\u8bf7\u6c42\u6570\u91cf\u589e \u5bb9\u6613 OOM ,\u800c\u7ebf\u7a0b\u5207\u6362\u7684\u5f00\u9500\u4e5f\u5f88\u5927,\u540c\u65f6\u7ebf\u7a0b\u7684\u521b\u5efa\u548c\u9500\u6bc1\u90fd\u662f\u7cfb\u7edf\u5f00\u9500,\u56e0\u6b64\u7528\u5185\u6838\u6765\u505a,\u89e3\u51b3\u7684\u65b9\u6cd5 \u53ef\u4ee5\u901a\u8fc7\u7ebf\u7a0b\u6c60\u6216\u534f\u7a0b\u89e3\u51b3"}),"\n",(0,t.jsx)(e.p,{children:"\u534f\u7a0b\u662f\u7528\u6237\u6001,\u6bd4\u5982\u7ebf\u7a0b\u66f4\u52a0\u8f7b\u91cf\u7ea7,\u64cd\u4f5c\u7cfb\u7edf\u5bf9\u5176\u6ca1\u6709\u4efb\u4f55\u611f\u77e5,\u4e4b\u6240\u4ee5\u6ca1\u6709\u611f\u77e5,\u662f\u7531\u4e8e\u5904\u4e8e\u534f\u7a0b\u7684\u7528\u6237\u6808\u611f\u77e5\u7684\u670d\u52a1,\u662f\u7531\u7528\u6237\u521b\u5efa\u800c\u975e\u64cd\u4f5c\u7cfb\u7edf"}),"\n",(0,t.jsx)(e.p,{children:"\u5982\u4e00\u4e2a\u8fdb\u7a0b\u53ef\u62e5\u6709\u4ee5\u6709\u591a\u4e2a\u7ebf\u7a0b\u4e00\u6837\uff0c\u4e00\u4e2a\u7ebf\u7a0b\u4e5f\u53ef\u4ee5\u62e5\u6709\u591a\u4e2a\u534f\u7a0b\u3002\u534f\u7a0b\u4e4b\u4e8e\u7ebf\u7a0b\u5982\u540c\u7ebf\u7a0b\u4e4b\u4e8e cpu\uff0c\u62e5\u6709\u81ea\u5df1\u7684\u534f\u7a0b\u961f\u5217\uff0c\u6bcf\u4e2a\u534f\u7a0b\u62e5\u6709\u81ea\u5df1\u7684\u6808\u7a7a\u95f4\uff0c\u5728\u534f\u7a0b\u5207\u6362\u65f6\u5019\u53ea\u9700\u8981\u4fdd\u5b58\u534f\u7a0b\u7684\u4e0a\u4e0b\u6587\uff0c\u5f00\u9500\u8981\u6bd4\u5185\u6838\u6001\u7684\u7ebf\u7a0b\u5207\u6362\u8981\u5c0f\u5f88\u591a\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"\u5b9a\u4e49",children:"\u5b9a\u4e49"}),"\n",(0,t.jsx)(e.p,{children:"Goroutine \u7684\u5e76\u53d1\u7f16\u7a0b\u6a21\u578b\u57fa\u4e8e GMP \u6a21\u578b\uff0c\u7b80\u8981\u89e3\u91ca\u4e00\u4e0b GMP \u7684\u542b\u4e49\uff1a"}),"\n",(0,t.jsx)(e.p,{children:"G:\u8868\u793a goroutine\uff0c\u6bcf\u4e2a goroutine \u90fd\u6709\u81ea\u5df1\u7684\u6808\u7a7a\u95f4\uff0c\u5b9a\u65f6\u5668\uff0c\u521d\u59cb\u5316\u7684\u6808\u7a7a\u95f4\u5728 2k \u5de6\u53f3\uff0c\u7a7a\u95f4\u4f1a\u968f\u7740\u9700\u6c42\u589e\u957f"}),"\n",(0,t.jsx)(e.p,{children:"M:\u62bd\u8c61\u5316\u4ee3\u8868\u5185\u6838\u7ebf\u7a0b\uff0c\u8bb0\u5f55\u5185\u6838\u7ebf\u7a0b\u6808\u4fe1\u606f\uff0c\u5f53 goroutine \u8c03\u5ea6\u5230\u7ebf\u7a0b\u65f6\uff0c\u4f7f\u7528\u8be5 goroutine \u81ea\u5df1\u7684\u6808\u4fe1\u606f\u3002"}),"\n",(0,t.jsx)(e.p,{children:"P:\u4ee3\u8868\u8c03\u5ea6\u5668\uff0c\u8d1f\u8d23\u8c03\u5ea6 goroutine\uff0c\u7ef4\u62a4\u4e00\u4e2a\u672c\u5730 goroutine \u961f\u5217\uff0cM \u4ece P \u4e0a\u83b7\u5f97 goroutine \u5e76\u6267\u884c\uff0c\u540c\u65f6\u8fd8\u8d1f\u8d23\u90e8\u5206\u5185\u5b58\u7684\u7ba1\u7406\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"\u6a21\u578b",children:"\u6a21\u578b"}),"\n",(0,t.jsx)(e.p,{children:"M \u4ee3\u8868\u4e00\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\uff0c\u5728 M \u4e0a\u6709\u4e00\u4e2a P \u548c G\uff0cP \u662f\u7ed1\u5b9a\u5230 M \u4e0a\u7684\uff0cG \u662f\u901a\u8fc7 P \u7684\u8c03\u5ea6\u83b7\u53d6\u7684\uff0c\u5728\u67d0\u4e00\u65f6\u523b\uff0c\u4e00\u4e2a M \u4e0a\u53ea\u6709\u4e00\u4e2a G\uff08g0 \u9664\u5916\uff09\u3002\u5728 P \u4e0a\u62e5\u6709\u4e00\u4e2a G \u961f\u5217\uff0c\u91cc\u9762\u662f\u5df2\u7ecf\u5c31\u7eea\u7684 G\uff0c\u662f\u53ef\u4ee5\u88ab\u8c03\u5ea6\u5230\u7ebf\u7a0b\u6808\u4e0a\u6267\u884c\u7684\u534f\u7a0b\uff0c\u79f0\u4e3a\u8fd0\u884c\u961f\u5217\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u63a5\u4e0b\u6765\u770b\u4e00\u4e0b\u7a0b\u5e8f\u4e2d GMP \u7684\u5206\u5e03\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u6bcf\u4e2a\u8fdb\u7a0b\u90fd\u6709\u4e00\u4e2a\u5168\u5c40\u7684 G \u961f\u5217\uff0c\u4e5f\u62e5\u6709 P \u7684\u672c\u5730\u6267\u884c\u961f\u5217\uff0c\u540c\u65f6\u4e5f\u6709\u4e0d\u5728\u8fd0\u884c\u961f\u5217\u4e2d\u7684 G\u3002\u5982\u6b63\u5904\u4e8e channel \u7684\u963b\u585e\u72b6\u6001\u7684 G\uff0c\u8fd8\u6709\u8131\u79bb P \u7ed1\u5b9a\u5728 M \u7684(\u7cfb\u7edf\u8c03\u7528)G\uff0c\u8fd8\u6709\u6267\u884c\u7ed3\u675f\u540e\u8fdb\u5165 P \u7684 gFree \u5217\u8868\u4e2d\u7684 G \u7b49\u7b49\uff0c\u63a5\u4e0b\u6765\u5217\u4e3e\u4e00\u4e0b\u5e38\u89c1\u7684\u51e0\u79cd\u72b6\u6001\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"\u72b6\u6001\u6c47\u603b",children:"\u72b6\u6001\u6c47\u603b"}),"\n",(0,t.jsx)(e.h4,{id:"g-\u72b6\u6001",children:"G \u72b6\u6001"}),"\n",(0,t.jsx)(e.p,{children:"G \u7684\u4e3b\u8981\u51e0\u79cd\u72b6\u6001\uff1a"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"\u672c\u6587\u57fa\u4e8e Go1.13\uff0c\u5177\u4f53\u4ee3\u7801\u89c1 src/runtime/runtime2.go"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"_Gidle\uff1a\u521a\u521a\u88ab\u5206\u914d\u5e76\u4e14\u8fd8\u6ca1\u6709\u88ab\u521d\u59cb\u5316\uff0c\u503c\u4e3a 0\uff0c\u4e3a\u521b\u5efa goroutine \u540e\u7684\u9ed8\u8ba4\u503c"}),"\n",(0,t.jsx)(e.p,{children:"_Grunnable\uff1a \u6ca1\u6709\u6267\u884c\u4ee3\u7801\uff0c\u6ca1\u6709\u6808\u7684\u6240\u6709\u6743\uff0c\u5b58\u50a8\u5728\u8fd0\u884c\u961f\u5217\u4e2d\uff0c\u53ef\u80fd\u5728\u67d0\u4e2a P \u7684\u672c\u5730\u961f\u5217\u6216\u5168\u5c40\u961f\u5217\u4e2d(\u5982\u4e0a\u56fe)\u3002"}),"\n",(0,t.jsx)(e.p,{children:"_Grunning\uff1a \u6b63\u5728\u6267\u884c\u4ee3\u7801\u7684 goroutine\uff0c\u62e5\u6709\u6808\u7684\u6240\u6709\u6743(\u5982\u4e0a\u56fe)\u3002"}),"\n",(0,t.jsx)(e.p,{children:"_Gsyscall\uff1a\u6b63\u5728\u6267\u884c\u7cfb\u7edf\u8c03\u7528\uff0c\u62e5\u6709\u6808\u7684\u6240\u6709\u6743\uff0c\u4e0e P \u8131\u79bb\uff0c\u4f46\u662f\u4e0e\u67d0\u4e2a M \u7ed1\u5b9a\uff0c\u4f1a\u5728\u8c03\u7528\u7ed3\u675f\u540e\u88ab\u5206\u914d\u5230\u8fd0\u884c\u961f\u5217(\u5982\u4e0a\u56fe)\u3002"}),"\n",(0,t.jsx)(e.p,{children:"_Gwaiting\uff1a\u88ab\u963b\u585e\u7684 goroutine\uff0c\u963b\u585e\u5728\u67d0\u4e2a channel \u7684\u53d1\u9001\u6216\u8005\u63a5\u6536\u961f\u5217(\u5982\u4e0a\u56fe)\u3002"}),"\n",(0,t.jsx)(e.p,{children:"_Gdead\uff1a \u5f53\u524d goroutine \u672a\u88ab\u4f7f\u7528\uff0c\u6ca1\u6709\u6267\u884c\u4ee3\u7801\uff0c\u53ef\u80fd\u6709\u5206\u914d\u7684\u6808\uff0c\u5206\u5e03\u5728\u7a7a\u95f2\u5217\u8868 gFree\uff0c\u53ef\u80fd\u662f\u4e00\u4e2a\u521a\u521a\u521d\u59cb\u5316\u7684 goroutine\uff0c\u4e5f\u53ef\u80fd\u662f\u6267\u884c\u4e86 goexit \u9000\u51fa\u7684 goroutine(\u5982\u4e0a\u56fe)\u3002"}),"\n",(0,t.jsx)(e.p,{children:"_Gcopystac\uff1a\u6808\u6b63\u5728\u88ab\u62f7\u8d1d\uff0c\u6ca1\u6709\u6267\u884c\u4ee3\u7801\uff0c\u4e0d\u5728\u8fd0\u884c\u961f\u5217\u4e0a\uff0c\u6267\u884c\u6743\u5728"}),"\n",(0,t.jsx)(e.p,{children:"_Gscan \uff1a GC \u6b63\u5728\u626b\u63cf\u6808\u7a7a\u95f4\uff0c\u6ca1\u6709\u6267\u884c\u4ee3\u7801\uff0c\u53ef\u4ee5\u4e0e\u5176\u4ed6\u72b6\u6001\u540c\u65f6\u5b58\u5728"}),"\n",(0,t.jsx)(e.h4,{id:"p-\u7684\u72b6\u6001",children:"P \u7684\u72b6\u6001"}),"\n",(0,t.jsx)(e.p,{children:"_Pidle \uff1a\u5904\u7406\u5668\u6ca1\u6709\u8fd0\u884c\u7528\u6237\u4ee3\u7801\u6216\u8005\u8c03\u5ea6\u5668\uff0c\u88ab\u7a7a\u95f2\u961f\u5217\u6216\u8005\u6539\u53d8\u5176\u72b6\u6001\u7684\u7ed3\u6784\u6301\u6709\uff0c\u8fd0\u884c\u961f\u5217\u4e3a\u7a7a"}),"\n",(0,t.jsx)(e.p,{children:"_Prunning \uff1a\u88ab\u7ebf\u7a0b M \u6301\u6709\uff0c\u5e76\u4e14\u6b63\u5728\u6267\u884c\u7528\u6237\u4ee3\u7801\u6216\u8005\u8c03\u5ea6\u5668(\u5982\u4e0a\u56fe)"}),"\n",(0,t.jsx)(e.p,{children:"_Psyscall\uff1a\u6ca1\u6709\u6267\u884c\u7528\u6237\u4ee3\u7801\uff0c\u5f53\u524d\u7ebf\u7a0b\u9677\u5165\u7cfb\u7edf\u8c03\u7528(\u5982\u4e0a\u56fe)"}),"\n",(0,t.jsx)(e.p,{children:"_Pgcstop \uff1a\u88ab\u7ebf\u7a0b M \u6301\u6709\uff0c\u5f53\u524d\u5904\u7406\u5668\u7531\u4e8e\u5783\u573e\u56de\u6536\u88ab\u505c\u6b62"}),"\n",(0,t.jsx)(e.p,{children:"_Pdead \uff1a\u5f53\u524d\u5904\u7406\u5668\u5df2\u7ecf\u4e0d\u88ab\u4f7f\u7528"}),"\n",(0,t.jsx)(e.h4,{id:"m-\u7684\u72b6\u6001",children:"M \u7684\u72b6\u6001"}),"\n",(0,t.jsx)(e.p,{children:"\u81ea\u65cb\u7ebf\u7a0b\uff1a\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\u4f46\u662f\u6ca1\u6709\u53ef\u6267\u884c goroutine \u7684\u7ebf\u7a0b(\u5982\u4e0b\u56fe)\uff0c\u6570\u91cf\u6700\u591a\u4e3a GOMAXPROC\uff0c\u82e5\u662f\u6570\u91cf\u5927\u4e8e GOMAXPROC \u5c31\u4f1a\u8fdb\u5165\u4f11\u7720\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u975e\u81ea\u65cb\u7ebf\u7a0b\uff1a\u5904\u4e8e\u8fd0\u884c\u72b6\u6001\u6709\u53ef\u6267\u884c goroutine \u7684\u7ebf\u7a0b\u3002"}),"\n",(0,t.jsx)(e.h4,{id:"\u8c03\u5ea6\u573a\u666f",children:"\u8c03\u5ea6\u573a\u666f"}),"\n",(0,t.jsx)(e.p,{children:"Channel \u963b\u585e\uff1a\u5f53 goroutine \u8bfb\u5199 channel \u53d1\u751f\u963b\u585e\u65f6\u5019\uff0c\u4f1a\u8c03\u7528 gopark \u51fd\u6570\uff0c\u8be5 G \u4f1a\u8131\u79bb\u5f53\u524d\u7684 M \u4e0e P\uff0c\u8c03\u5ea6\u5668\u4f1a\u6267\u884c schedule \u51fd\u6570\u8c03\u5ea6\u65b0\u7684 G \u5230\u5f53\u524d M\u3002\u53ef\u53c2\u8003\u4e0a\u4e00\u7bc7\u6587\u7ae0 channel \u63a2\u79d8\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u7cfb\u7edf\u8c03\u7528\uff1a\u5f53\u67d0\u4e2a G \u7531\u4e8e\u7cfb\u7edf\u8c03\u7528\u9677\u5165\u5185\u6838\u6001\u65f6\uff0c\u8be5 P \u5c31\u4f1a\u8131\u79bb\u5f53\u524d\u7684 M\uff0c\u6b64\u65f6 P \u4f1a\u66f4\u65b0\u81ea\u5df1\u7684\u72b6\u6001\u4e3a Psyscall\uff0cM \u4e0e G \u4e92\u76f8\u7ed1\u5b9a\uff0c\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\u3002\u7ed3\u675f\u4ee5\u540e\u82e5\u8be5 P \u72b6\u6001\u8fd8\u662f Psyscall\uff0c\u5219\u76f4\u63a5\u5173\u8054\u8be5 M \u548c G\uff0c\u5426\u5219\u4f7f\u7528\u95f2\u7f6e\u7684\u5904\u7406\u5668\u5904\u7406\u8be5 G\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u7cfb\u7edf\u76d1\u63a7\uff1a\u5f53\u67d0\u4e2a G \u5728 P \u4e0a\u8fd0\u884c\u7684\u65f6\u95f4\u8d85\u8fc7 10ms \u65f6\u5019\uff0c\u6216\u8005 P \u5904\u4e8e Psyscall \u72b6\u6001\u8fc7\u957f\u7b49\u60c5\u51b5\u5c31\u4f1a\u8c03\u7528 retake \u51fd\u6570\uff0c\u89e6\u53d1\u65b0\u7684\u8c03\u5ea6\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u4e3b\u52a8\u8ba9\u51fa\uff1a\u7531\u4e8e\u662f\u534f\u4f5c\u5f0f\u8c03\u5ea6\uff0c\u8be5 G \u4f1a\u4e3b\u52a8\u8ba9\u51fa\u5f53\u524d\u7684 P\uff0c\u66f4\u65b0\u72b6\u6001\u4e3a Grunnable\uff0c\u8be5 P \u4f1a\u8c03\u5ea6\u961f\u5217\u4e2d\u7684 G \u8fd0\u884c\u3002"}),"\n",(0,t.jsx)(e.h4,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,t.jsx)(e.p,{children:"Go \u8bed\u8a00\u4e2d\u901a\u8fc7 GMP \u6a21\u578b\u5b9e\u73b0\u4e86\u5bf9 CPU \u548c\u5185\u5b58\u7684\u5408\u7406\u5229\u7528\uff0c\u4f7f\u5f97\u7528\u6237\u5728\u4e0d\u7528\u62c5\u5fc3\u5185\u5b58\u7684\u60c5\u51b5\u4e0b\u4f53\u9a8c\u5230\u7ebf\u7a0b\u7684\u597d\u5904\u3002\u867d\u8bf4\u534f\u7a0b\u7684\u7a7a\u95f4\u5f88\u5c0f\uff0c\u4f46\u662f\u4e5f\u9700\u8981\u5173\u6ce8\u4e00\u4e0b\u534f\u7a0b\u7684\u751f\u547d\u5468\u671f\uff0c\u9632\u6b62\u8fc7\u591a\u7684\u534f\u7a0b\u6ede\u7559\u9020\u6210 OOM\u3002\u6700\u8fd1\u9047\u5230\u4e86\u7ebf\u4e0a\u7684 OOM \u95ee\u9898\uff0c\u7b49\u5f85\u4e0b\u671f\u4e00\u8d77\u5206\u6790"}),"\n",(0,t.jsx)(e.h2,{id:"go-\u6253\u5305",children:"GO \u6253\u5305"}),"\n",(0,t.jsx)(e.h3,{id:"\u6253\u5305-linux",children:"\u6253\u5305 linux"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o  "xxxx" xxxx.go\n'})}),"\n",(0,t.jsx)(e.h3,{id:"\u6253\u5305-windows",children:"\u6253\u5305 windows"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o  "xxxx" xxxx.go\n'})}),"\n",(0,t.jsx)(e.h3,{id:"\u6253\u5305-mac",children:"\u6253\u5305 mac"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-bash",children:'CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -o  "xxxx" xxxx.go\n'})}),"\n",(0,t.jsx)(e.h2,{id:"go-\u4e4b-context",children:"Go \u4e4b context"}),"\n",(0,t.jsx)(e.h3,{id:"\u4e3a\u4ec0\u4e48\u9700\u8981-context",children:"\u4e3a\u4ec0\u4e48\u9700\u8981 context"}),"\n",(0,t.jsx)(e.p,{children:"\u5728\u5e76\u53d1\u7a0b\u5e8f\u4e2d\uff0c\u7531\u4e8e\u8d85\u65f6\u3001\u53d6\u6d88\u64cd\u4f5c\u6216\u8005\u4e00\u4e9b\u5f02\u5e38\u60c5\u51b5\uff0c\u5f80\u5f80\u9700\u8981\u8fdb\u884c\u62a2\u5360\u64cd\u4f5c\u6216\u8005\u4e2d\u65ad\u540e\u7eed\u64cd\u4f5c\u3002\u719f\u6089 channel \u7684\u670b\u53cb\u5e94\u8be5\u90fd\u89c1\u8fc7\u4f7f\u7528 done channel"}),"\n",(0,t.jsx)(e.h3,{id:"context-\u63a5\u53e3",children:"context \u63a5\u53e3"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"type Context interface {\n\n    Deadline() (deadline time.Time, ok bool)\n\n    Done() <-chan struct{}\n\n    Err() error\n\n    Value(key interface{}) interface{}\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"Context \u63a5\u53e3\u5305\u542b\u56db\u4e2a\u65b9\u6cd5\uff1a"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"Deadline \u8fd4\u56de\u7ed1\u5b9a\u5f53\u524d context \u7684\u4efb\u52a1\u88ab\u53d6\u6d88\u7684\u622a\u6b62\u65f6\u95f4\uff1b\u5982\u679c\u6ca1\u6709\u8bbe\u5b9a\u671f\u9650\uff0c\u5c06\u8fd4\u56de ok == false\u3002"}),"\n",(0,t.jsx)(e.li,{children:"Done \u5f53\u7ed1\u5b9a\u5f53\u524d context \u7684\u4efb\u52a1\u88ab\u53d6\u6d88\u65f6\uff0c\u5c06\u8fd4\u56de\u4e00\u4e2a\u5173\u95ed\u7684 channel\uff1b\u5982\u679c\u5f53\u524d context \u4e0d\u4f1a\u88ab\u53d6\u6d88\uff0c\u5c06\u8fd4\u56de nil\u3002"}),"\n",(0,t.jsx)(e.li,{children:"Err \u5982\u679c Done \u8fd4\u56de\u7684 channel \u6ca1\u6709\u5173\u95ed\uff0c\u5c06\u8fd4\u56de nil;\u5982\u679c Done \u8fd4\u56de\u7684 channel \u5df2\u7ecf\u5173\u95ed\uff0c\u5c06\u8fd4\u56de\u975e\u7a7a\u7684\u503c\u8868\u793a\u4efb\u52a1\u7ed3\u675f\u7684\u539f\u56e0\u3002\u5982\u679c\u662f context \u88ab\u53d6\u6d88\uff0cErr \u5c06\u8fd4\u56de Canceled\uff1b\u5982\u679c\u662f context \u8d85\u65f6\uff0cErr \u5c06\u8fd4\u56de DeadlineExceeded\u3002"}),"\n",(0,t.jsx)(e.li,{children:"Value \u8fd4\u56de context \u5b58\u50a8\u7684\u952e\u503c\u5bf9\u4e2d\u5f53\u524d key \u5bf9\u5e94\u7684\u503c\uff0c\u5982\u679c\u6ca1\u6709\u5bf9\u5e94\u7684 key,\u5219\u8fd4\u56de nil\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"emptyctx",children:"emptyCtx"}),"\n",(0,t.jsx)(e.p,{children:"emptyCtx \u662f\u4e00\u4e2a int \u7c7b\u578b\u7684\u53d8\u91cf\uff0c\u4f46\u5b9e\u73b0\u4e86 context \u7684\u63a5\u53e3\u3002emptyCtx \u6ca1\u6709\u8d85\u65f6\u65f6\u95f4\uff0c\u4e0d\u80fd\u53d6\u6d88\uff0c\u4e5f\u4e0d\u80fd\u5b58\u50a8\u4efb\u4f55\u989d\u5916\u4fe1\u606f\uff0c\u6240\u4ee5 emptyCtx \u7528\u6765\u4f5c\u4e3a context \u6811\u7684\u6839\u8282\u70b9\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:'type emptyCtx int\n\nfunc (*emptyCtx) Deadline() (deadline time.Time, ok bool) {\n    return\n}\n\nfunc (*emptyCtx) Done() <-chan struct{} {\n    return nil\n}\n\nfunc (*emptyCtx) Err() error {\n    return nil\n}\n\nfunc (*emptyCtx) Value(key interface{}) interface{} {\n    return nil\n}\n\nfunc (e *emptyCtx) String() string {\n    switch e {\n    case background:\n        return "context.Background"\n    case todo:\n        return "context.TODO"\n    }\n    return "unknown empty Context"\n}\n\nvar (\n    background = new(emptyCtx)\n    todo       = new(emptyCtx)\n)\n\nfunc Background() Context {\n    return background\n}\n\nfunc TODO() Context {\n    return todo\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u4f46\u6211\u4eec\u4e00\u822c\u4e0d\u4f1a\u76f4\u63a5\u4f7f\u7528 emptyCtx\uff0c\u800c\u662f\u4f7f\u7528\u7531 emptyCtx \u5b9e\u4f8b\u5316\u7684\u4e24\u4e2a\u53d8\u91cf\uff0c\u5206\u522b\u53ef\u4ee5\u901a\u8fc7\u8c03\u7528 Background \u548c TODO \u65b9\u6cd5\u5f97\u5230\uff0c\u4f46\u8fd9\u4e24\u4e2a context \u5728\u5b9e\u73b0\u4e0a\u662f\u4e00\u6837\u7684\u3002\u90a3\u4e48 Background \u548c TODO \u65b9\u6cd5\u5f97\u5230\u7684 context \u6709\u4ec0\u4e48\u533a\u522b\u5462\uff1f\u53ef\u4ee5\u770b\u4e00\u4e0b\u5b98\u65b9\u7684\u89e3\u91ca\uff1a Background \u548c TODO \u53ea\u662f\u7528\u4e8e\u4e0d\u540c\u573a\u666f\u4e0b\uff1a Background \u901a\u5e38\u88ab\u7528\u4e8e\u4e3b\u51fd\u6570\u3001\u521d\u59cb\u5316\u4ee5\u53ca\u6d4b\u8bd5\u4e2d\uff0c\u4f5c\u4e3a\u4e00\u4e2a\u9876\u5c42\u7684 context\uff0c\u4e5f\u5c31\u662f\u8bf4\u4e00\u822c\u6211\u4eec\u521b\u5efa\u7684 context \u90fd\u662f\u57fa\u4e8e Background\uff1b\u800c TODO \u662f\u5728\u4e0d\u786e\u5b9a\u4f7f\u7528\u4ec0\u4e48 context \u7684\u65f6\u5019\u624d\u4f1a\u4f7f\u7528\u4e0b\u9762\u5c06\u4ecb\u7ecd\u4e24\u79cd\u4e0d\u540c\u529f\u80fd\u7684\u57fa\u7840 context \u7c7b\u578b\uff1avalueCtx \u548c cancelCtx\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"valuectx",children:"valueCtx"}),"\n",(0,t.jsx)(e.p,{children:"valueCtx \u7ed3\u6784\u4f53"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"type valueCtx struct {\n    Context\n    key, val interface{}\n}\n\nfunc (c *valueCtx) Value(key interface{}) interface{} {\n    if c.key == key {\n        return c.val\n    }\n    return c.Context.Value(key)\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"valueCtx \u5229\u7528\u4e00\u4e2a Context \u7c7b\u578b\u7684\u53d8\u91cf\u6765\u8868\u793a\u7236\u8282\u70b9 context\uff0c\u6240\u4ee5\u5f53\u524d context \u7ee7\u627f\u4e86\u7236 context \u7684\u6240\u6709\u4fe1\u606f\uff1bvalueCtx \u7c7b\u578b\u8fd8\u643a\u5e26\u4e00\u7ec4\u952e\u503c\u5bf9\uff0c\u4e5f\u5c31\u662f\u8bf4\u8fd9\u79cd context \u53ef\u4ee5\u643a\u5e26\u989d\u5916\u7684\u4fe1\u606f\u3002valueCtx \u5b9e\u73b0\u4e86 Value \u65b9\u6cd5\uff0c\u7528\u4ee5\u5728 context \u94fe\u8def\u4e0a\u83b7\u53d6 key \u5bf9\u5e94\u7684\u503c\uff0c\u5982\u679c\u5f53\u524d context \u4e0a\u4e0d\u5b58\u5728\u9700\u8981\u7684 key,\u4f1a\u6cbf\u7740 context \u94fe\u5411\u4e0a\u5bfb\u627e key \u5bf9\u5e94\u7684\u503c\uff0c\u76f4\u5230\u6839\u8282\u70b9\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"withvalue",children:"WithValue"}),"\n",(0,t.jsx)(e.p,{children:"WithValue \u7528\u4ee5\u5411 context \u6dfb\u52a0\u952e\u503c\u5bf9\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:'func WithValue(parent Context, key, val interface{}) Context {\n    if key == nil {\n        panic("nil key")\n    }\n    if !reflect.TypeOf(key).Comparable() {\n        panic("key is not comparable")\n    }\n    return &valueCtx{parent, key, val}\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u8fd9\u91cc\u6dfb\u52a0\u952e\u503c\u5bf9\u4e0d\u662f\u5728\u539f context \u7ed3\u6784\u4f53\u4e0a\u76f4\u63a5\u6dfb\u52a0\uff0c\u800c\u662f\u4ee5\u6b64 context \u4f5c\u4e3a\u7236\u8282\u70b9\uff0c\u91cd\u65b0\u521b\u5efa\u4e00\u4e2a\u65b0\u7684 valueCtx \u5b50\u8282\u70b9\uff0c\u5c06\u952e\u503c\u5bf9\u6dfb\u52a0\u5728\u5b50\u8282\u70b9\u4e0a\uff0c\u7531\u6b64\u5f62\u6210\u4e00\u6761 context \u94fe\u3002\u83b7\u53d6 value \u7684\u8fc7\u7a0b\u5c31\u662f\u5728\u8fd9\u6761 context \u94fe\u4e0a\u7531\u5c3e\u90e8\u4e0a\u524d\u641c\u5bfb\uff1a"}),"\n",(0,t.jsx)(e.h3,{id:"cancelctx",children:"cancelCtx"}),"\n",(0,t.jsx)(e.p,{children:"cancelCtx \u7ed3\u6784\u4f53"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"type cancelCtx struct {\n    Context\n\n    mu       sync.Mutex            // protects following fields\n    done     chan struct{}         // created lazily, closed by first cancel call\n    children map[canceler]struct{} // set to nil by the first cancel call\n    err      error                 // set to non-nil by the first cancel call\n}\n\ntype canceler interface {\n    cancel(removeFromParent bool, err error)\n    Done() <-chan struct{}\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u8ddf valueCtx \u7c7b\u4f3c\uff0ccancelCtx \u4e2d\u4e5f\u6709\u4e00\u4e2a context \u53d8\u91cf\u4f5c\u4e3a\u7236\u8282\u70b9\uff1b\u53d8\u91cf done \u8868\u793a\u4e00\u4e2a channel\uff0c\u7528\u6765\u8868\u793a\u4f20\u9012\u5173\u95ed\u4fe1\u53f7\uff1bchildren \u8868\u793a\u4e00\u4e2a map\uff0c\u5b58\u50a8\u4e86\u5f53\u524d context \u8282\u70b9\u4e0b\u7684\u5b50\u8282\u70b9\uff1berr \u7528\u4e8e\u5b58\u50a8\u9519\u8bef\u4fe1\u606f\u8868\u793a\u4efb\u52a1\u7ed3\u675f\u7684\u539f\u56e0\u3002"}),"\n",(0,t.jsx)(e.p,{children:"\u518d\u6765\u770b\u4e00\u4e0bcancelCtx\u5b9e\u73b0\u7684\u65b9\u6cd5\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"func (c *cancelCtx) Done() <-chan struct{} {\n    c.mu.Lock()\n    if c.done == nil {\n        c.done = make(chan struct{})\n    }\n    d := c.done\n    c.mu.Unlock()\n    return d\n}\n\nfunc (c *cancelCtx) Err() error {\n    c.mu.Lock()\n    err := c.err\n    c.mu.Unlock()\n    return err\n}\n\nfunc (c *cancelCtx) cancel(removeFromParent bool, err error) {\n    if err == nil {\n        panic(\"context: internal error: missing cancel error\")\n    }\n    c.mu.Lock()\n    if c.err != nil {\n        c.mu.Unlock()\n        return // already canceled\n    }\n    // \u8bbe\u7f6e\u53d6\u6d88\u539f\u56e0\n    c.err = err\n    \u8bbe\u7f6e\u4e00\u4e2a\u5173\u95ed\u7684channel\u6216\u8005\u5c06done channel\u5173\u95ed\uff0c\u7528\u4ee5\u53d1\u9001\u5173\u95ed\u4fe1\u53f7\n    if c.done == nil {\n        c.done = closedchan\n    } else {\n        close(c.done)\n    }\n    // \u5c06\u5b50\u8282\u70b9context\u4f9d\u6b21\u53d6\u6d88\n    for child := range c.children {\n        // NOTE: acquiring the child's lock while holding parent's lock.\n        child.cancel(false, err)\n    }\n    c.children = nil\n    c.mu.Unlock()\n\n    if removeFromParent {\n        // \u5c06\u5f53\u524dcontext\u8282\u70b9\u4ece\u7236\u8282\u70b9\u4e0a\u79fb\u9664\n        removeChild(c.Context, c)\n    }\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u53ef\u4ee5\u53d1\u73b0 cancelCtx \u7c7b\u578b\u53d8\u91cf\u5176\u5b9e\u4e5f\u662f canceler \u7c7b\u578b\uff0c\u56e0\u4e3a cancelCtx \u5b9e\u73b0\u4e86 canceler \u63a5\u53e3\u3002 Done \u65b9\u6cd5\u548c Err \u65b9\u6cd5\u6ca1\u5fc5\u8981\u8bf4\u4e86\uff0ccancelCtx \u7c7b\u578b\u7684 context \u5728\u8c03\u7528 cancel \u65b9\u6cd5\u65f6\u4f1a\u8bbe\u7f6e\u53d6\u6d88\u539f\u56e0\uff0c\u5c06 done channel \u8bbe\u7f6e\u4e3a\u4e00\u4e2a\u5173\u95ed channel \u6216\u8005\u5173\u95ed channel\uff0c\u7136\u540e\u5c06\u5b50\u8282\u70b9 context \u4f9d\u6b21\u53d6\u6d88\uff0c\u5982\u679c\u6709\u9700\u8981\u8fd8\u4f1a\u5c06\u5f53\u524d\u8282\u70b9\u4ece\u7236\u8282\u70b9\u4e0a\u79fb\u9664\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"withcancel",children:"WithCancel"}),"\n",(0,t.jsx)(e.p,{children:"WithCancel \u51fd\u6570\u7528\u6765\u521b\u5efa\u4e00\u4e2a\u53ef\u53d6\u6d88\u7684 context\uff0c\u5373 cancelCtx \u7c7b\u578b\u7684 context\u3002WithCancel \u8fd4\u56de\u4e00\u4e2a context \u548c\u4e00\u4e2a CancelFunc\uff0c\u8c03\u7528 CancelFunc \u5373\u53ef\u89e6\u53d1 cancel \u64cd\u4f5c\u3002\u76f4\u63a5\u770b\u6e90\u7801\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"type CancelFunc func()\n\nfunc WithCancel(parent Context) (ctx Context, cancel CancelFunc) {\n    c := newCancelCtx(parent)\n    propagateCancel(parent, &c)\n    return &c, func() { c.cancel(true, Canceled) }\n}\n\n// newCancelCtx returns an initialized cancelCtx.\nfunc newCancelCtx(parent Context) cancelCtx {\n    // \u5c06parent\u4f5c\u4e3a\u7236\u8282\u70b9context\u751f\u6210\u4e00\u4e2a\u65b0\u7684\u5b50\u8282\u70b9\n    return cancelCtx{Context: parent}\n}\n\nfunc propagateCancel(parent Context, child canceler) {\n    if parent.Done() == nil {\n        // parent.Done()\u8fd4\u56denil\u8868\u660e\u7236\u8282\u70b9\u4ee5\u4e0a\u7684\u8def\u5f84\u4e0a\u6ca1\u6709\u53ef\u53d6\u6d88\u7684context\n        return // parent is never canceled\n    }\n    // \u83b7\u53d6\u6700\u8fd1\u7684\u7c7b\u578b\u4e3acancelCtx\u7684\u7956\u5148\u8282\u70b9\n    if p, ok := parentCancelCtx(parent); ok {\n        p.mu.Lock()\n        if p.err != nil {\n            // parent has already been canceled\n            child.cancel(false, p.err)\n        } else {\n            if p.children == nil {\n                p.children = make(map[canceler]struct{})\n            }\n            // \u5c06\u5f53\u524d\u5b50\u8282\u70b9\u52a0\u5165\u6700\u8fd1cancelCtx\u7956\u5148\u8282\u70b9\u7684children\u4e2d\n            p.children[child] = struct{}{}\n        }\n        p.mu.Unlock()\n    } else {\n        go func() {\n            select {\n            case <-parent.Done():\n                child.cancel(false, parent.Err())\n            case <-child.Done():\n            }\n        }()\n    }\n}\n\nfunc parentCancelCtx(parent Context) (*cancelCtx, bool) {\n    for {\n        switch c := parent.(type) {\n        case *cancelCtx:\n            return c, true\n        case *timerCtx:\n            return &c.cancelCtx, true\n        case *valueCtx:\n            parent = c.Context\n        default:\n            return nil, false\n        }\n    }\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u4e4b\u524d\u8bf4\u5230 cancelCtx \u53d6\u6d88\u65f6\uff0c\u4f1a\u5c06\u540e\u4ee3\u8282\u70b9\u4e2d\u6240\u6709\u7684 cancelCtx \u90fd\u53d6\u6d88\uff0cpropagateCancel \u5373\u7528\u6765\u5efa\u7acb\u5f53\u524d\u8282\u70b9\u4e0e\u7956\u5148\u8282\u70b9\u8fd9\u4e2a\u53d6\u6d88\u5173\u8054\u903b\u8f91\u3002"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"\u5982\u679c parent.Done()\u8fd4\u56de nil\uff0c\u8868\u660e\u7236\u8282\u70b9\u4ee5\u4e0a\u7684\u8def\u5f84\u4e0a\u6ca1\u6709\u53ef\u53d6\u6d88\u7684 context\uff0c\u4e0d\u9700\u8981\u5904\u7406\uff1b"}),"\n",(0,t.jsx)(e.li,{children:"\u5982\u679c\u5728 context \u94fe\u4e0a\u627e\u5230\u5230 cancelCtx \u7c7b\u578b\u7684\u7956\u5148\u8282\u70b9\uff0c\u5219\u5224\u65ad\u8fd9\u4e2a\u7956\u5148\u8282\u70b9\u662f\u5426\u5df2\u7ecf\u53d6\u6d88\uff0c\u5982\u679c\u5df2\u7ecf\u53d6\u6d88\u5c31\u53d6\u6d88\u5f53\u524d\u8282\u70b9\uff1b\u5426\u5219\u5c06\u5f53\u524d\u8282\u70b9\u52a0\u5165\u5230\u7956\u5148\u8282\u70b9\u7684 children \u5217\u8868\u3002"}),"\n",(0,t.jsx)(e.li,{children:"\u5426\u5219\u5f00\u542f\u4e00\u4e2a\u534f\u7a0b\uff0c\u76d1\u542c parent.Done()\u548c child.Done()\uff0c\u4e00\u65e6 parent.Done()\u8fd4\u56de\u7684 channel \u5173\u95ed\uff0c\u5373 context \u94fe\u4e2d\u67d0\u4e2a\u7956\u5148\u8282\u70b9 context \u88ab\u53d6\u6d88\uff0c\u5219\u5c06\u5f53\u524d context \u4e5f\u53d6\u6d88\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.p,{children:"\u5f53\u524d cancelCtx \u7684\u7236\u8282\u70b9 context \u5e76\u4e0d\u662f\u4e00\u4e2a\u53ef\u53d6\u6d88\u7684 context\uff0c\u4e5f\u5c31\u6ca1\u6cd5\u8bb0\u5f55 children\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"timerctx",children:"timerCtx"}),"\n",(0,t.jsx)(e.p,{children:"timerCtx \u662f\u4e00\u79cd\u57fa\u4e8e cancelCtx \u7684 context \u7c7b\u578b\uff0c\u4ece\u5b57\u9762\u4e0a\u5c31\u80fd\u770b\u51fa\uff0c\u8fd9\u662f\u4e00\u79cd\u53ef\u4ee5\u5b9a\u65f6\u53d6\u6d88\u7684 context\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"type timerCtx struct {\n    cancelCtx\n    timer *time.Timer // Under cancelCtx.mu.\n\n    deadline time.Time\n}\n\nfunc (c *timerCtx) Deadline() (deadline time.Time, ok bool) {\n    return c.deadline, true\n}\n\nfunc (c *timerCtx) cancel(removeFromParent bool, err error) {\n    \u5c06\u5185\u90e8\u7684cancelCtx\u53d6\u6d88\n    c.cancelCtx.cancel(false, err)\n    if removeFromParent {\n        // Remove this timerCtx from its parent cancelCtx's children.\n        removeChild(c.cancelCtx.Context, c)\n    }\n    c.mu.Lock()\n    if c.timer != nil {\n        \u53d6\u6d88\u8ba1\u65f6\u5668\n        c.timer.Stop()\n        c.timer = nil\n    }\n    c.mu.Unlock()\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"timerCtx \u5185\u90e8\u4f7f\u7528 cancelCtx \u5b9e\u73b0\u53d6\u6d88\uff0c\u53e6\u5916\u4f7f\u7528\u5b9a\u65f6\u5668 timer \u548c\u8fc7\u671f\u65f6\u95f4 deadline \u5b9e\u73b0\u5b9a\u65f6\u53d6\u6d88\u7684\u529f\u80fd\u3002timerCtx \u5728\u8c03\u7528 cancel \u65b9\u6cd5\uff0c\u4f1a\u5148\u5c06\u5185\u90e8\u7684 cancelCtx \u53d6\u6d88\uff0c\u5982\u679c\u9700\u8981\u5219\u5c06\u81ea\u5df1\u4ece cancelCtx \u7956\u5148\u8282\u70b9\u4e0a\u79fb\u9664\uff0c\u6700\u540e\u53d6\u6d88\u8ba1\u65f6\u5668\u3002"}),"\n",(0,t.jsx)(e.h3,{id:"withdeadline",children:"WithDeadline"}),"\n",(0,t.jsx)(e.p,{children:"WithDeadline \u8fd4\u56de\u4e00\u4e2a\u57fa\u4e8e parent \u7684\u53ef\u53d6\u6d88\u7684 context\uff0c\u5e76\u4e14\u5176\u8fc7\u671f\u65f6\u95f4 deadline \u4e0d\u665a\u4e8e\u6240\u8bbe\u7f6e\u65f6\u95f4 d\u3002"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) {\n    if cur, ok := parent.Deadline(); ok && cur.Before(d) {\n        // The current deadline is already sooner than the new one.\n        return WithCancel(parent)\n    }\n    c := &timerCtx{\n        cancelCtx: newCancelCtx(parent),\n        deadline:  d,\n    }\n    // \u5efa\u7acb\u65b0\u5efacontext\u4e0e\u53ef\u53d6\u6d88context\u7956\u5148\u8282\u70b9\u7684\u53d6\u6d88\u5173\u8054\u5173\u7cfb\n    propagateCancel(parent, c)\n    dur := time.Until(d)\n    if dur <= 0 {\n        c.cancel(true, DeadlineExceeded) // deadline has already passed\n        return c, func() { c.cancel(false, Canceled) }\n    }\n    c.mu.Lock()\n    defer c.mu.Unlock()\n    if c.err == nil {\n        c.timer = time.AfterFunc(dur, func() {\n            c.cancel(true, DeadlineExceeded)\n        })\n    }\n    return c, func() { c.cancel(true, Canceled) }\n}\n"})}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"\u5982\u679c\u7236\u8282\u70b9 parent \u6709\u8fc7\u671f\u65f6\u95f4\u5e76\u4e14\u8fc7\u671f\u65f6\u95f4\u65e9\u4e8e\u7ed9\u5b9a\u65f6\u95f4 d\uff0c\u90a3\u4e48\u65b0\u5efa\u7684\u5b50\u8282\u70b9 context \u65e0\u9700\u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4\uff0c\u4f7f\u7528 WithCancel \u521b\u5efa\u4e00\u4e2a\u53ef\u53d6\u6d88\u7684 context \u5373\u53ef\uff1b"}),"\n",(0,t.jsx)(e.li,{children:"\u5426\u5219\uff0c\u5c31\u8981\u5229\u7528 parent \u548c\u8fc7\u671f\u65f6\u95f4 d \u521b\u5efa\u4e00\u4e2a\u5b9a\u65f6\u53d6\u6d88\u7684 timerCtx\uff0c\u5e76\u5efa\u7acb\u65b0\u5efa context \u4e0e\u53ef\u53d6\u6d88 context \u7956\u5148\u8282\u70b9\u7684\u53d6\u6d88\u5173\u8054\u5173\u7cfb\uff0c\u63a5\u4e0b\u6765\u5224\u65ad\u5f53\u524d\u65f6\u95f4\u8ddd\u79bb\u8fc7\u671f\u65f6\u95f4 d \u7684\u65f6\u957f dur\uff1a"}),"\n",(0,t.jsx)(e.li,{children:"\u5982\u679c dur \u5c0f\u4e8e 0\uff0c\u5373\u5f53\u524d\u5df2\u7ecf\u8fc7\u4e86\u8fc7\u671f\u65f6\u95f4\uff0c\u5219\u76f4\u63a5\u53d6\u6d88\u65b0\u5efa\u7684 timerCtx\uff0c\u539f\u56e0\u4e3a DeadlineExceeded\uff1b"}),"\n",(0,t.jsx)(e.li,{children:"\u5426\u5219\uff0c\u4e3a\u65b0\u5efa\u7684 timerCtx \u8bbe\u7f6e\u5b9a\u65f6\u5668\uff0c\u4e00\u65e6\u5230\u8fbe\u8fc7\u671f\u65f6\u95f4\u5373\u53d6\u6d88\u5f53\u524d timerCtx\u3002"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"withtimeout",children:"WithTimeout"}),"\n",(0,t.jsx)(e.p,{children:"\u4e0e WithDeadline \u7c7b\u4f3c\uff0cWithTimeout \u4e5f\u662f\u521b\u5efa\u4e00\u4e2a\u5b9a\u65f6\u53d6\u6d88\u7684 context\uff0c\u53ea\u4e0d\u8fc7 WithDeadline \u662f\u63a5\u6536\u4e00\u4e2a\u8fc7\u671f\u65f6\u95f4\u70b9\uff0c\u800c WithTimeout \u63a5\u6536\u4e00\u4e2a\u76f8\u5bf9\u5f53\u524d\u65f6\u95f4\u7684\u8fc7\u671f\u65f6\u957f timeout:"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:"func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) {\n    return WithDeadline(parent, time.Now().Add(timeout))\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"context-\u7684\u4f7f\u7528",children:"context \u7684\u4f7f\u7528"}),"\n",(0,t.jsx)(e.p,{children:"\u9996\u5148\u4f7f\u7528 context \u5b9e\u73b0\u6587\u7ae0\u5f00\u5934 done channel \u7684\u4f8b\u5b50\u6765\u793a\u8303\u4e00\u4e0b\u5982\u4f55\u66f4\u4f18\u96c5\u5b9e\u73b0\u534f\u7a0b\u95f4\u53d6\u6d88\u4fe1\u53f7\u7684\u540c\u6b65\uff1a"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-go",children:'func main() {\n    messages := make(chan int, 10)\n\n    // producer\n    for i := 0; i < 10; i++ {\n        messages <- i\n    }\n\n    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)\n\n    // consumer\n    go func(ctx context.Context) {\n        ticker := time.NewTicker(1 * time.Second)\n        for _ = range ticker.C {\n            select {\n            case <-ctx.Done():\n                fmt.Println("child process interrupt...")\n                return\n            default:\n                fmt.Printf("send message: %d\\n", <-messages)\n            }\n        }\n    }(ctx)\n\n    defer close(messages)\n    defer cancel()\n\n    select {\n    case <-ctx.Done():\n        time.Sleep(1 * time.Second)\n        fmt.Println("main process exit!")\n    }\n}\n'})}),"\n",(0,t.jsx)(e.p,{children:"\u53ea\u8981\u8ba9\u5b50\u7ebf\u7a0b\u76d1\u542c\u4e3b\u7ebf\u7a0b\u4f20\u5165\u7684 ctx\uff0c\u4e00\u65e6 ctx.Done()\u8fd4\u56de\u7a7a channel\uff0c\u5b50\u7ebf\u7a0b\u5373\u53ef\u53d6\u6d88\u6267\u884c\u4efb\u52a1\u3002\u4f46\u8fd9\u4e2a\u4f8b\u5b50\u8fd8\u65e0\u6cd5\u5c55\u73b0 context \u7684\u4f20\u9012\u53d6\u6d88\u4fe1\u606f\u7684\u5f3a\u5927\u4f18\u52bf."}),"\n",(0,t.jsx)(e.h3,{id:"\u603b\u7ed3-1",children:"\u603b\u7ed3"}),"\n",(0,t.jsx)(e.p,{children:"context \u4e3b\u8981\u7528\u4e8e\u7236\u5b50\u4efb\u52a1\u4e4b\u95f4\u7684\u540c\u6b65\u53d6\u6d88\u4fe1\u53f7\uff0c\u672c\u8d28\u4e0a\u662f\u4e00\u79cd\u534f\u7a0b\u8c03\u5ea6\u7684\u65b9\u5f0f\u3002\u53e6\u5916\u5728\u4f7f\u7528 context \u65f6\u6709\u4e24\u70b9\u503c\u5f97\u6ce8\u610f\uff1a\u4e0a\u6e38\u4efb\u52a1\u4ec5\u4ec5\u4f7f\u7528 context \u901a\u77e5\u4e0b\u6e38\u4efb\u52a1\u4e0d\u518d\u9700\u8981\uff0c\u4f46\u4e0d\u4f1a\u76f4\u63a5\u5e72\u6d89\u548c\u4e2d\u65ad\u4e0b\u6e38\u4efb\u52a1\u7684\u6267\u884c\uff0c\u7531\u4e0b\u6e38\u4efb\u52a1\u81ea\u884c\u51b3\u5b9a\u540e\u7eed\u7684\u5904\u7406\u64cd\u4f5c\uff0c\u4e5f\u5c31\u662f\u8bf4 context \u7684\u53d6\u6d88\u64cd\u4f5c\u662f\u65e0\u4fb5\u5165\u7684\uff1bcontext \u662f\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u56e0\u4e3a context \u672c\u8eab\u662f\u4e0d\u53ef\u53d8\u7684\uff08immutable\uff09\uff0c\u56e0\u6b64\u53ef\u4ee5\u653e\u5fc3\u5730\u5728\u591a\u4e2a\u534f\u7a0b\u4e2d\u4f20\u9012\u4f7f\u7528\u3002"})]})}function x(n={}){const{wrapper:e}={...(0,l.a)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(s,{...n})}):s(n)}},11151:(n,e,c)=>{c.d(e,{Z:()=>a,a:()=>r});var t=c(67294);const l={},i=t.createContext(l);function r(n){const e=t.useContext(i);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:r(n.components),t.createElement(i.Provider,{value:e},n.children)}}}]);